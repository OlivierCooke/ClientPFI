<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta author="OlivierCooke/AlexandreLeblanc">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Worthy</title>

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <!-- favicon link: use https://favicon.io/favicon-converter/ to create new favicon -->
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
</head>

<body class="style-4">
    <!-- navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark shadow">
        <div class="container-fluid gap-2">
            <a class="navbar-brand" href="#">
                <img src="./assets/logo.png" width="50" height="50" />
            </a>

            <div class="collapse navbar-collapse flex-grow-0 gap-2" id="navbarSupportedContent">
                <button type="button" class="btn btn-outline-primary shadow-sm visually-hidden" id="addNews"
                    data-bs-toggle="modal" data-bs-target="#createModal">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <div id="dropdownContainer" class="dropdown visually-hidden">
                    <button class="btn btn-outline-primary dropdown-toggle shadow-sm" type="button" id="cmbAuthor"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        Filter Author
                    </button>
                    <ul id="dropdownAuthors" class="dropdown-menu style-4" aria-labelledby="cmbAuthor">
                    </ul>
                </div>
                <input id="searchInput" class="form-control visually-hidden" type="search"
                    placeholder="Search by key words" aria-label="Search">
                <button id="btnSearchSubmit" class="btn btn-outline-primary visually-hidden"
                    onclick="updateNewsSearch()">Search</button>
            </div>
            <div class="d-flex flex-row justify-content-end gap-2 flex-grow-1">
                <div class="connectedContainer d-flex flex-row gap-2 visually-hidden">
                    <div id="avatarContainer" class="shadow-sm">
                        <div class='avatar'
                            style='background:url(" https://avatars.dicebear.com/api/bottts/qwerty.png ") no-repeat center; background-size: cover;'>
                        </div>
                    </div>
                    <div class='unameContainer d-flex flex-row align-items-center justify-content-center my-cu'>
                        <span id="link_OpenProfilDialog" class="ellipsis">My UName</span>
                    </div>
                    <button id="submitLogout" type="button" class="btn btn-outline-primary shadow-sm my-cu">
                        <span>Log Out</span>
                    </button>
                </div>
                <div class=" disconnectedContainer d-flex flex-row gap-2">
                    <button type="button" class="btn btn-primary shadow-sm my-cu" id="login" data-bs-toggle="modal"
                        data-bs-target="#loginModal">
                        <span>Login</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary shadow-sm my-cu" id="register"
                        data-bs-toggle="modal" data-bs-target="#registerModal">
                        <span>Register</span>
                    </button>
                </div>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
    </nav>

    <!--empty container-->
    <div id="mainContainer" class="container overflow-auto style-4" style="margin-top: 80px; height: 91vh;">

    </div>


    <!-- RegisterModal -->
    <div class="modal fade style-4" id="registerModal" tabindex="-1" aria-labelledby="RegisterModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h2 class="modal-title flex-fill text-center registerTitle" id="RegisterModalLabel">Register</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="registerForm" class="d-grid gap-2">
                        <div class="form-input"> <input id="registerUname" type="text" class="form-control"
                                placeholder="Username">
                        </div>
                        <span id="unameError" class="text-center text-danger visually-hidden"> Invalid username</span>
                        <div class="form-input"> <input id="registerEmail" type="text" class="form-control"
                                placeholder="Email address">
                        </div>
                        <span id="emailError" class="text-center text-danger visually-hidden"> Invalid email</span>
                        <div class="form-input"> <input id="registerPassword" type="password" class="form-control"
                                placeholder="Password">
                        </div><span id="passwordError" class="text-center text-danger visually-hidden"> Invalid
                            password</span>
                        <div class="form-input"> <input id="registerPasswordConfirmation" type="password"
                                class="form-control" placeholder="Confirm Password">
                        </div>
                        <span id="passwordCError" class="text-center text-danger visually-hidden"> Passwords are not the
                            same</span>
                        <div class="imageDownloader" id="avatar" defautimagesrc="assets/user.png"></div>
                        <button id="submitRegister" class="btn btn-primary mt-4">Register</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END RegisterModal -->

    <!-- UpdateModal -->
    <div class="modal fade style-4" id="updateModal" tabindex="-1" aria-labelledby="UpdateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h2 class="modal-title flex-fill text-center updateTitle" id="UpdateModalLabel">Update Profile</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="updateForm" class="d-grid gap-2">
                        <input type="hidden" id="avatarGUID" value="">
                        <div class="form-input"> <input id="updateUname" type="text" class="form-control"
                                placeholder="Username">
                        </div>
                        <span id="unameErrorUpdate" class="text-center text-danger visually-hidden"> Invalid
                            username</span>
                        <div class="form-input"> <input id="updateEmail" type="text" class="form-control"
                                placeholder="Email address">
                        </div>
                        <span id="emailErrorUpdate" class="text-center text-danger visually-hidden"> Invalid
                            email</span>
                        <div class="form-input"> <input id="updatePassword" type="password" class="form-control"
                                placeholder="Password">
                        </div>
                        <div class="form-input"> <input id="updatePasswordConfirmation" type="password"
                                class="form-control" placeholder="Confirm Password">
                        </div>
                        <span id="passwordCErrorUpdate" class="text-center text-danger visually-hidden"> Passwords are
                            not the
                            same</span>
                        <div class="imageDownloader" id="avatarUpdate" defautimagesrc="assets/user.png"></div>
                        <button id="submitupdate" class="btn btn-primary mt-4">Save Changes</button>
                        <button id="submitUnsubscribe" class="btn btn-primary mt-4" data-bs-toggle="modal"
                            data-bs-target="#deleteAccountModal" onclick="deleteUser()">Unsubscribe</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END UpdateModal -->

    <!-- LoginModal -->
    <div class="modal fade style-4" id="loginModal" tabindex="-1" aria-labelledby="LoginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h2 class="modal-title flex-fill text-center loginTitle" id="LoginModalLabel">Login</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <span id="errorLogin" class="text-center text-danger visually-hidden">Credentials are
                            shizzled...</span>
                        <div class="form-input"> <input id="loginEmail" type="text" class="form-control"
                                placeholder="Email address">
                        </div>
                        <div class="form-input"> <input id="loginPassword" type="password" class="form-control"
                                placeholder="Password">
                        </div>
                        <div class="form-check"> <input id="remember-me" class="form-check-input" type="checkbox"
                                value="" id="flexCheckChecked" checked> <label class="form-check-label"
                                for="flexCheckChecked">
                                Remember me </label> </div>
                        <button id="submitLogin" class="btn btn-primary mt-4">Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END LoginModal -->

    <!--CreatePostModal-->
    <div class="modal fade style-4" id="createModal" tabindex="-1" aria-labelledby="createModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h2 class="modal-title flex-fill text-center registerTitle" id="createModalLabel">Share the news
                    </h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        onclick="startRefresh()"></button>
                </div>
                <div class="modal-body">
                    <div id="createForm" class="d-grid gap-2">
                        <div class="form-input">
                            <input id="createTitle" type="text" class="form-control" placeholder="Title">
                        </div>
                        <span id="createTitleError" class="text-center text-danger visually-hidden"> Invalid
                            title</span>
                        <div class="imageDownloader" id="imageCreate" defautimagesrc="assets/user.png"></div>
                        <span id="imageCreateError" class="text-center text-danger visually-hidden"> There must be an
                            image</span>
                        <div class="form-input">
                            <textarea id="createDescription" class="form-control overflow-auto style-4"
                                placeholder="Describe the news..."></textarea>
                        </div>
                        <span id="createDescriptionError" class="text-center text-danger visually-hidden"> Invalid
                            description</span>
                        <button id="submitCreate" class="btn btn-primary mt-4">Publish</button>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--END CreatePostModal-->

    <!-- Validation delete post -->
    <div class="modal fade style-4" id="deletePostModal" tabindex="-1" aria-labelledby="deletePostModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h3 class="modal-title flex-fill text-center registerTitle" id="deletePostModalLabel">
                        Your about to delete this post:<br>
                        <span id="deleteTitle">Nom du post</span>
                    </h3>
                </div>
                <div class="modal-body">
                    <div id="deletePostForm" class="d-flex flex-row justify-content-center gap-2">
                        <button id="deletePostConfirmation" type="button" class="btn-danger" data-bs-dismiss="modal"
                            aria-label="Confirm">Confirm</button>
                        <button type="button" class="btn-primary" data-bs-dismiss="modal"
                            aria-label="Cancel">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Validation delete user -->
    <div class="modal fade style-4" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h3 class="modal-title flex-fill text-center registerTitle" id="deleteAccountModalLabel">
                        Your about to unsubscribe:<br>
                        <span>Are you sure ?</span>
                    </h3>
                </div>
                <div class="modal-body">
                    <div id="deleteAccountForm" class="d-flex flex-row justify-content-center gap-2">
                        <button id="deleteAccountConfirmation" type="button" class="btn-danger" data-bs-dismiss="modal"
                            aria-label="Confirm">Confirm</button>
                        <button type="button" class="btn-primary" data-bs-dismiss="modal"
                            aria-label="Cancel">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- END Validation delete post-->
</body>
<script src="js/bootstrap.js"></script>
<script src="js/jquery-3.5.1.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/Validation.js"></script>
<script src="js/WebAPIRequest.js"></script>
<script src="js/jquery-confirm.js"></script>
<script src="js/jquery.maskedinput.js"></script>
<script src="js/imageUploadUtilities.js"></script>

<script>
    "use strict";
    $(document).ready(initUI);

    let editMode = false;
    let addMode = false;
    let editProfil = false;
    let connected = false;
    let queryString = "";
    let search = "";
    let searchShowed = false;
    //let sorted = [{ field: "Created", desc: true }];
    let currentETag = "";
    let previousQueryString = "";
    let photoValidationProvider = null;
    let profilValidationProvider = null;
    //let pauseNewsListPeriodicRefresh = false;
    let periodicRefreshPeriod = 5; // seconds


    //GENERAL CODE
    function installPeriodicnewsListRefresh() {
        setInterval(() => {
            if (!operationOnGoing() & connected) getNews();
        }, periodicRefreshPeriod * 1000);
    }

    function initUI() {

        emptyMainContainer();

        installPeriodicnewsListRefresh();

        $("#submitLogin").click(Login)
        $('#submitLogout').click(Logout)
        $('#submitRegister').click(validInputRegister)
        $('#submitupdate').click(saveChanges)
        $('#submitCreate').click(create)
        $('#addNews').click(() => {
            console.log('stop');
            addMode = true;
        });

        $('#loginModal').on('shown.bs.modal', function (event) {
            if (localStorage.getItem('rememberme') == "1") {
                $("#remember-me").attr("checked", "checked");
                let email = localStorage.getItem('loginemail');
                let password = localStorage.getItem('loginpassword');
                if (email) $("#loginEmail").val(email);
                if (password) $("#loginPassword").val(password);
            } else {
                $("#loginEmail").val("");
                $("#loginPassword").val("");
            }
        });
        $('#loginModal').on('hidden.bs.modal', function (event) {
            if ($('#remember-me').is(":checked")) {
                localStorage.setItem('rememberme', "1");
                localStorage.setItem('loginemail', $("#loginEmail").val());
                localStorage.setItem('loginpassword', $("#loginPassword").val());
            } else {
                localStorage.setItem('rememberme', "0");
                localStorage.removeItem('loginemail');
                localStorage.removeItem('loginpassword');
            }
        });

        // register events
        $('#registerModal').on('shown.bs.modal', function (event) {

            $('#registerUname').val('');
            $('#registerEmail').val('');
            $('#registerPassword').val('');
            $('#registerPasswordConfirmation').val('');
            $('.imageDownloader').empty();
            $('.imageDownloader').attr('defautimagesrc', '/assets/user.png')
            $('#avatarUpdate_ImageData').val()
            createUploader()
        });
        $('#registerModal').on('hidden.bs.modal', function (event) {

            $('#registerUname').val('');
            $('#registerEmail').val('');
            $('#registerPassword').val('');
            $('#registerPasswordConfirmation').val('');
            $('.imageDownloader').empty();
            $('.imageDownloader').attr('defautimagesrc', '/assets/user.png')
            createUploader()
        });



        $('#updateModal').on('hidden.bs.modal', function (event) {
            editMode = true;

            $('#emailErrorUpdate').addClass('visually-hidden');
            $('#unameErrorUpdate').addClass('visually-hidden');
            $('#passwordCErrorUpdate').addClass('visually-hidden');
            $('#updatePassword').val('');
            $('#updatePasswordConfirmation').val('');

            $('.imageDownloader').empty();
            $('.imageDownloader').attr('defautimagesrc', '/assets/user.png')
            createUploader()
        });
        $('#createModal').on('hidden.bs.modal', function (event) {
            $('#createTitleError').addClass('visually-hidden');
            $('#imageCreateError').addClass('visually-hidden');
            $('#createDescriptionError').addClass('visually-hidden');
            $('#createTitle').val('');
            $('#createDescription').val('');
            $('.imageDownloader').empty();
            $('.imageDownloader').attr('defautimagesrc', '/assets/user.png')
            createUploader()

        })
    }

    function closeAllDialog() {
        editMode = false;
        addMode = false;
        console.log('go');
        editProfil = false;
        $('#registerModal').modal('hide')
        $('#loginModal').modal('hide')
    }

    function Alert(message) {
        $.confirm({
            title: message,
            content: '',
            buttons: {
                close: function () { }
            }
        });
    }

    function AlertError(status) {
        $.confirm({
            title: '<img src="assets/error.png" style="width:40px;margin:10px" alt="httpError"/>Encountered an error!',
            content: statusToString(status) + ' (' + status + ')',
            type: 'red',
            typeAnimated: true,
            buttons: {

                close: {
                    btnClass: 'btn-red',
                    action: function () {
                        this.close();
                        if (status == 401) {
                            forceLogout();
                        }
                        pauseNewsListPeriodicRefresh = true;
                    }
                }
            }
        });
    }

    function statusToString(status) {
        let text = "Le server ne répond pas.";
        switch (status) {
            case 401: text = "Request not authorized. You need to be logged in."; break;
            case 409: text = "Data Conflict. Request was rejected."; break;
            case 422: text = "Data format was incorrect. Request was rejected."; break;
        }
        return text;
    }

    function operationOnGoing() {
        return addMode || editMode || editProfil;
    }

    function startRefresh() {
        addMode = false;
        editMode = false;
        editProfil = false;
        console.log('go')
    }
    //USER FUNCTION:

    function Unsubscribe(id) {
        let idLogUser = retrieveLoggedUser().Id
        console.log('avant call id : ', id)
        if (id != idLogUser)
            forceLogout()
        else {
            webAPI_DELETE_Account(id, forceLogout, AlertError);
        }
    }

    function deleteUser() {
        let id = retrieveLoggedUser().Id
        console.log(id)
        $('#deleteAccountConfirmation').click(() => { Unsubscribe(id) })
    }

    function updateProfile() {
        if (connected) {
            let profile = retrieveLoggedUser()
            $('#updateModal').modal('show');
            $('#avatarGUID').val(profile.AvatarGUID)
            $('#updateUname').val(profile.Name)
            $('#updateEmail').val(profile.Email)
            setImageDownloaderImage('avatarUpdate', retrieveLoggedUser().AvatarURL)
            editProfil = true
        }
    }

    //DISPLAY FUNCTION
    function emptyMainContainer() {
        let filler = '<div id="imageEmptyContainer" class=" d-flex flex-column empty flex-grow-0 m-auto">'
        filler += '<img id="imageEmpty" class="img-fluid" src="/assets/empty.png">'
        filler += '<span id="textEmpty" class="text-white text-center"> Wow, such emptyness...</span></div>'

        $('#mainContainer').addClass('d-flex');

        $('#mainContainer').append(filler);
    }

    function updateUI() {
        updateConnected();
        if (connected) {
            getNews(true);
            loadAuthorsNames();
        }

    }
    //SEARCH FUNCTION

    function loadAuthorsNames() {
        webAPI_AUTHORS(putAuthorsNameInList, AlertError)
    }

    function putAuthorsNameInList(news) {
        $('#dropdownAuthors').empty();
        $('#dropdownAuthors').append('<li class="liInAuthors">All authors</li>');
        $('#dropdownAuthors').append('<li class="liInAuthors">My news</li>');
        news.forEach(element => {
            $('#dropdownAuthors').append('<li class="liInAuthors">' + element + '</li>');
        });


        $('.liInAuthors').click((e) => {
            let text = e.currentTarget.textContent;
            searchByAuthors(text);
        })
    }


    //POST FUNCTIONS

    function modifyPost(id) {
        //Pour le partial refresh
        editMode = true;
        let newTitle = $('#title_Input_' + id).val();
        let newDescription = $('#description_' + id).val();
        let image = $('#e_imageCreate_ImageUploader').val();

        console.log(newTitle);
        console.log(newDescription);

        let errorFound = false;

        if (!newTitle) {
            errorFound = true;
            $('#createTitleError').removeClass('visually-hidden');
        }
        else {
            $('#createTitleError').addClass('visually-hidden');
        }

        if (!newDescription) {
            errorFound = true;
            $('#createDescriptionError').removeClass('visually-hidden');
        }
        else {
            $('#createDescriptionError').addClass('visually-hidden');
        }

        if (errorFound) {
            console.log('errorFound')
            e.preventDefault()
        }
        else {
            let userLog = retrieveLoggedUser();
            let data = {
                Id: parseInt(id),
                UserId: userLog['Id'],
                Titre: newTitle,
                Description: newDescription,
                ImageData: getImageData(id)
            }
            webAPI_PUT(data, getNews, AlertError);
            startRefresh();
        }
    }

    /*
        Details: This function is use to create a new post
    */
    function create(e) {

        addMode = true;

        let createTitle = $('#createTitle').val();
        let description = $('#createDescription').val();
        let image = $('#e_imageCreate_ImageUploader').val();

        let errorFound = false;

        if (!createTitle) {
            errorFound = true;
            $('#createTitleError').removeClass('visually-hidden');
        }
        else {
            $('#createTitleError').addClass('visually-hidden');
        }

        if (!description) {
            errorFound = true;
            $('#createDescriptionError').removeClass('visually-hidden');
        }
        else {
            $('#createDescriptionError').addClass('visually-hidden');
        }

        if (image == "" || image == null || image == undefined) {
            errorFound = true;
            $('#imageCreateError').removeClass('visually-hidden');
        }
        else {
            $('#imageCreateError').addClass('visually-hidden');
        }

        if (errorFound) {
            console.log('errorFound')
            e.preventDefault()
        }
        else {
            let userLog = retrieveLoggedUser();
            let data = {
                Id: 0,
                UserId: userLog['Id'],
                Titre: createTitle,
                Description: description,
                ImageData: getImageData('imageCreate')
            }
            webAPI_POST(data, () => { $('#createModal').modal('hide'); () => { console.log('create réussi') }; }, AlertError);
        }
    }



    //LOGIN AND LOGOUT FUNCTIONS


    function forceLogout() {
        Alert("You have been disconnected.");
        closeAllDialog();
        connected = false;
        updateUI(true);
    }

    function Logout() {
        connected = false;
        webAPI_logout(retrieveLoggedUser().Id, updateUI, AlertError)
    }

    function Login() {
        webAPI_login($("#loginEmail").val(),
            $("#loginPassword").val(),
            updateUI,
            () => {
                $('#errorLogin').removeClass('visually-hidden')
            })
    }



    function updateConnected() {

        connected = false;
        let username = "";
        if (retrieveLoggedUser() != null) {
            username = retrieveLoggedUser().Name;
            connected = true;
        }
        if (connected) {
            $('#errorLogin').addClass('visually-hidden')
            setUsername(username);
            $("#avatarContainer").empty();
            $("#avatarContainer").append(html_fittedAvatar(retrieveLoggedUser().AvatarURL, 'avatar'));
            $('.connectedContainer').removeClass('visually-hidden')
            $('.disconnectedContainer').addClass('visually-hidden')
            $('#loginModal').modal('hide');
            $('#addNews').removeClass('visually-hidden')
            $('#mainContainer').empty();
            $('#dropdownContainer').removeClass('visually-hidden');
            $('#btnSearchSubmit').removeClass('visually-hidden');
            $('#searchInput').removeClass('visually-hidden');

        }
        else {
            $("#avatarContainer").empty();
            $('link_OpenProfilDialog').empty();
            $('.connectedContainer').addClass('visually-hidden')
            $('.disconnectedContainer').removeClass('visually-hidden')
            $('#addNews').addClass('visually-hidden')
            $('#mainContainer').empty();
            emptyMainContainer();
            $('#dropdownContainer').addClass('visually-hidden');
            $('#btnSearchSubmit').addClass('visually-hidden');
            $('#searchInput').addClass('visually-hidden');
        }
    }


    //POST TEMPLATE FUNCTIONS

    function postTemplateOwner(news) {
        console.log(news);
        let title = news['Titre'];
        let description = news['Description'];
        let imageUrlPost = news['OriginalURL'];
        let profileUrl = "https://smooth-square-egg.glitch.me/images/" + news['imageProfile'] + ".png";
        let date = news['Date']
        let username = news['Username']
        let id = news['Id']
        let iupParam = '\"' + imageUrlPost + '\"';
        let post = "";
        post += '<div class="container mt-2 mb-2">'
        post += '<div class="row d-flex align-items-center justify-content-center">'
        post += '<div class="col-md-6">'
        //post += '<form action="#" method="post">'
        post += '<div id="card_' + id + '_glow" class="card text-white bg-dark shadow">'
        post += '<div class="d-flex justify-content-between p-2 px-3">'
        post += '<div class="d-flex flex-row align-items-center gap-2">'
        post += '<img src="' + profileUrl + '" width="40" class="rounded-circle">'
        post += '<div class="d-flex flex-column">'
        post += '<span class="font-weight-bold">' + username + '</span>'
        post += '<small class="mr-2">' + date + '</small></div></div>'
        post += '<div class="d-flex flex-row mt-1 gap-2">'
        post += '<button id="edit_btn_' + id + '" class="btn btn-outline-primary rounded-circle btnEdit" urlImage="' + imageUrlPost + '">'
        post += '<i class="bi bi-pencil"></i></button>'
        post += '<button hidden id="btn_submit_edit_' + id + '" class="btn btn-outline-primary rounded-circle" type="submit"><i class="bi bi-check-lg"></i></button>'
        post += '<button hidden id="btn_cancel_' + id + '" class="btn btn-outline-primary rounded-circle" onclick="cancelEdit(' + id + ')">'
        post += '<i class="bi bi-x-lg"></i></button>'
        post += '<button id="btn_delete_' + id + '" class="btn btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#deletePostModal" onclick="deletePost(' + id + ')">'
        post += '<i class="bi bi-x-lg"></i></button></div></div>'
        post += '<div id="card_' + id + '_title" class="text-white text-center fs-3 w-100">'
        post += '<span id="title_' + id + '">' + title + '</span>'
        post += '<input hidden id="title_Input_' + id + '" name="title" type="text" class="mb-2 mt-2 rounded border-3 border-primary" value="' + title + '"></input></div>'
        post += '<img id="image_displayer_' + id + '" src="' + imageUrlPost + '" class="img-fluid">'
        post += '<div class="visually-hidden" id="imagePost_' + id + '"defautimagesrc="' + imageUrlPost + '"></div>';
        post += '<div class="p-2"><hr>'
        post += ' <p id="card_' + id + '_description" class="overflow-auto style-4" style="max-height:150px;">' + description + '</p>'
        post += '<p id="card_' + id + '_edit_description" hidden class="text-justify text-center overflow-auto style-4" style="max-height:150px;"><textarea id="description_' + id + '" name="description" class="form-control style-4"></textarea></p>'
        post += '<hr></div></div>'
        post += '</form>'
        post += '</div></div></div></div>'

        document.getElementById('mainContainer').innerHTML += post;
    }

    function postTemplate(news) {
        let title = news['Titre'];
        let description = news['Description'];
        let imageUrlPost = news['OriginalURL'];
        let profileUrl = 'https://smooth-square-egg.glitch.me/images/' + news['imageProfile'] + ".png";
        let date = news['Date']
        let username = news['Username']
        let id = news['Id']
        let post = "";
        post += '<div class="container mt-2 mb-2">'
        post += '<div class="row d-flex align-items-center justify-content-center">'
        post += '<div class="col-md-6">'
        post += '<div class="card text-white bg-dark shadow">'
        post += '<div class="d-flex justify-content-between p-2 px-3">'
        post += '<div class="d-flex flex-row align-items-center gap-2">'
        post += '<img src="' + profileUrl + '" width="40" class="rounded-circle">'
        post += '<div class="d-flex flex-column">'
        post += '<span class="font-weight-bold">' + username + '</span>'
        post += '<small class="mr-2">' + date + '</small></div></div>'
        post += '<div class="d-flex flex-row mt-1 gap-2">'
        post += '</div></div>'
        post += '<div id="card_' + id + '_title" class="text-white text-center fs-3 w-100">'
        post += '<span id="title_' + id + '">' + title + '</span>'
        post += '</div>'
        post += '<img src="' + imageUrlPost + '" class="img-fluid">'
        post += '<div hidden id="image-uploader_' + id + '" class="image-upload">'
        post += '<label for="file-input">'
        post += '<img id="mainImage_' + id + '" src=' + imageUrlPost + '" class="img-fluid rounded"></label>'
        post += '</div>'
        post += '<div class="p-2"><hr>'
        post += ' <p id="card_' + id + '_description" class="overflow-auto style-4" style="max-height:150px;">' + description + '</p>'
        post += '<p id="card_' + id + '_edit_description" hidden class="text-justify text-center overflow-auto style-4" style="max-height:150px;"><textarea id="description_' + id + '" name="description" class="form-control style-4"></textarea></p>'
        post += '<hr></div></div>'
        post += '</div></div></div></div>'

        document.getElementById('mainContainer').innerHTML += post;
    }

    function getNews(forceRefreshphotoList = false) {
        if (forceRefreshphotoList) {
            if (queryString == "") {
                queryString = '?sort=Date,desc'
            }
            webAPI_GET_ALL(queryString, updateNewsList, AlertError);
        } else
            webAPI_HEAD(checkETag, AlertError);
    }

    function checkETag(ETag) {
        console.log('check etag')
        if (ETag != currentETag) {
            webAPI_GET_ALL('?sort=Date,desc', updateNewsList, AlertError);
        }
    }

    function updateNewsList(news, Etag) {
        //let mainContainer = '<div id="mainContainer" class="container overflow-auto style-4" style="margin-top: 80px; height: 91vh;"> </div>';
        currentETag = Etag;
        $('#mainContainer').removeClass('d-flex');
        $('#mainContainer').empty();
        let loggedUserId = (retrieveLoggedUser() ? retrieveLoggedUser().Id : null);
        news.forEach(post => {
            if (post.UserId == loggedUserId) {
                //Propriétaire
                postTemplateOwner(post);
                //$('#photoList').append(thumbNail(photo, loggedUserId));
            }
            else {
                postTemplate(post);
                //Non propriétaire
            }

        });

        $('.btnEdit').click((e) => {
            let id = e.currentTarget.id.split('_')[2];
            let url = e.currentTarget.getAttribute("urlimage");
            modify(id, url)
        })

    }

    function modify(id, url) {
        editMode = true;
        createSpecificUploader(id, url)
        let target = 'card_' + id;
        let title = document.getElementById('title_' + id).innerHTML;
        let description = $('#card_' + id + '_description').html();

        $('#description_' + id).val(description)
        document.getElementById('title_' + id).hidden = true;
        document.getElementById('title_Input_' + id).hidden = false;
        document.getElementById('title_' + id).value = title;
        document.getElementById('card_' + id + '_glow').classList.remove('shadow')
        document.getElementById('card_' + id + '_glow').style.boxShadow = '0 1rem 3rem  #398dff';

        document.getElementById('card_' + id + '_edit_description').hidden = false;
        //document.getElementById('description_'+id).value = description;
        document.getElementById('card_' + id + '_description').hidden = true;
        $('#imagePost_' + id).removeClass('visually-hidden')

        document.getElementById('image_displayer_' + id).hidden = true;

        document.getElementById('btn_cancel_' + id).hidden = false;
        document.getElementById('edit_btn_' + id).hidden = true;
        document.getElementById('btn_delete_' + id).hidden = true;
        document.getElementById('btn_submit_edit_' + id).hidden = false;

        $('#btn_submit_edit_' + id).click((e) => {
            let id = e.currentTarget.id.replace('btn_submit_edit_', '');
            console.log(id);
            //editMode = false
            //webAPI_PUT()

            modifyPost(id)

        })


    }

    function deletePost(id) {
        $('#deletePostConfirmation').click(() => { deletePostConfirm(id) })
    }

    function deletePostConfirm(id) {
        webAPI_DELETE(id, updateUI, AlertError)
    }

    function cancelEdit(id) {
        editMode = false
        let target = 'card_' + id;
        let title = document.getElementById(target + '_title').innerHTML;
        let description = document.getElementById(target + '_description').innerHTML;
        $('#imagePost_' + id).addClass('visually-hidden')
        document.getElementById('title_' + id).hidden = false;
        document.getElementById('title_Input_' + id).hidden = true;;
        document.getElementById('card_' + id + '_glow').classList.add('shadow')
        document.getElementById('card_' + id + '_glow').style.boxShadow = 'none';

        document.getElementById('card_' + id + '_edit_description').hidden = true;
        document.getElementById('card_' + id + '_description').hidden = false;
        document.getElementById('image_displayer_' + id).hidden = false;
        $('#imagePost').addClass('visually-hidden');

        document.getElementById('btn_cancel_' + id).hidden = true;
        document.getElementById('edit_btn_' + id).hidden = false;
        document.getElementById('btn_delete_' + id).hidden = false;

        document.getElementById('btn_submit_edit_' + id).hidden = true;
    }

    function setUsername(username) {
        $("#link_OpenProfilDialog").text(username)
        $("#link_OpenProfilDialog").click(updateProfile);
        $('#avatarContainer').click(updateProfile)
    }

    function html_fittedAvatar(Avatar_url, css = '') {
        return "<div class='" + css + "' style='background:url(" + Avatar_url + ") no-repeat center; background-size: cover;'></div>";
    }



    function validInputRegister(e) {
        let regexEmail = /^[a-zA-Z0-9.!#$%&'+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:.[a-zA-Z0-9-]+)$/
        let email = $('#registerEmail').val();
        let username = $('#registerUname').val();
        let confirmPassword = $('#registerPasswordConfirmation').val();
        let password = $('#registerPassword').val();
        let errorFound = false;

        if (!regexEmail.test(email)) {
            errorFound = true;
            $('#emailError').removeClass('visually-hidden');
        }
        else {
            $('#emailError').addClass('visually-hidden');
        }
        if (!username) {
            errorFound = true;
            $('#unameError').removeClass('visually-hidden');
        }
        else {
            $('#unameError').addClass('visually-hidden');
        }
        if (confirmPassword != password) {
            errorFound = true;
            $('#passwordCError').removeClass('visually-hidden');
        }
        else {
            $('#passwordCError').addClass('visually-hidden');
        }
        if (!password) {
            errorFound = true;
            $('#passwordError').removeClass('visually-hidden');
        }
        else {
            $('#passwordError').addClass('visually-hidden');
        }
        if (errorFound) {
            e.preventDefault()
        }
        else {
            let data = {
                Id: 0,
                Name: username,
                Email: email,
                Password: password,
                ImageData: getImageData('avatar')
            }
            webAPI_Register(data, () => { $('#registerModal').modal('hide'); updateUI(); }, AlertError);
        }

    }

    function saveChanges(e) {
        let regexEmail = /^[a-zA-Z0-9.!#$%&'+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:.[a-zA-Z0-9-]+)$/
        let avatarGUID = $("#avatarGUID").val();
        let email = $('#updateEmail').val();
        let username = $('#updateUname').val();
        let confirmPassword = $('#updatePasswordConfirmation').val();
        let password = $('#updatePassword').val();
        let errorFound = false;
        let id = retrieveLoggedUser().Id

        if (!regexEmail.test(email)) {
            errorFound = true;
            $('#emailErrorUpdate').removeClass('visually-hidden');
        }
        else {
            $('#emailErrorUpdate').addClass('visually-hidden');
        }
        if (!username) {
            errorFound = true;
            $('#unameErrorUpdate').removeClass('visually-hidden');
        }
        else {
            $('#unameErrorUpdate').addClass('visually-hidden');
        }
        if (confirmPassword != password) {
            errorFound = true;
            $('#passwordCErrorUpdate').removeClass('visually-hidden');
        }
        else {
            $('#passwordCErrorUpdate').addClass('visually-hidden');
        }
        if (errorFound) {
            e.preventDefault()
        }
        else {
            let data = {
                AvatarGUID: avatarGUID,
                Id: id,
                Name: username,
                Email: email,
                Password: password,
                ImageData: getImageData('avatarUpdate')
            }
            console.log(data)
            webAPI_ChangeProfil(data, () => { $('#updateModal').modal('hide'); updateUI(); })
        }
    }

    function updateNewsSearch() {
        queryString = "";

        let search = $('#searchInput').val();

        if (search != "") {
            queryString = "?Titre=" + search + "&" + "Description=" + search;
            console.log(queryString)
        }
        getNews(true);
    }

    function searchByAuthors(authorName) {

        if (authorName == "All authors") {
            queryString = "";
            getNews(true);
        }
        else if (authorName == "My news") {
            queryString = "?Username=" + $('#link_OpenProfilDialog').text();
            getNews(true);
        }
        else {
            queryString = "?Username=" + authorName;
            getNews(true);
        }

    }

</script>

</html>